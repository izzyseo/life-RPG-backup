<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Journal</title>
    <link rel="stylesheet" href="journal.css" />
    <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet">
    <style>
        textarea {
            font-family: 'Raleway', sans-serif;
            width: 100%;
            font-size: 1em;
            padding: 10px;
            border-radius: 10px;
            background-color: #ffcad253;
            resize: none;
            min-height: 100px;
        }
    </style>
</head>

<body>
    <div class="journal-container">
        <div class="journal-title">TODAY</div>
        <textarea id="journal-text" placeholder="How was today?"></textarea>

        <div class="date-list" id="date-list"></div>
    </div>

    <div class="calendar-container">
        <div id="calendar"></div>
        <div id="journal-display"></div> <!-- ì €ë„ ë‚´ìš©ì„ ë³´ì—¬ì¤„ ì˜ì—­ -->
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDCrNGJQJDVYhugWWkAtefikhzjzpOrphA",
            authDomain: "life-rpg-1.firebaseapp.com",
            projectId: "life-rpg-1",
            storageBucket: "life-rpg-1.firebasestorage.app",
            messagingSenderId: "41510513611",
            appId: "1:41510513611:web:602c4ec0ee81edee15644e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ğŸ”¹ ë‚ ì§œ í˜•ì‹ ë„ìš°ë¯¸
        function formatDate(date) {
            return date.toISOString().slice(0, 10); // yyyy-mm-dd
        }

        const today = new Date();
        const todayKey = formatDate(today);
        let selectedDate = todayKey;

        const textarea = document.getElementById("journal-text");
        const dateListEl = document.getElementById("date-list");

        // ì´ˆê¸°í™”
        let selectedStartDate = formatDate(today); // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‹œì‘

        // ğŸ”¹ ë‚ ì§œ ë²„íŠ¼ ë Œë”ë§
        function renderDateButtons() {
            const dateListEl = document.getElementById("date-list");
            dateListEl.innerHTML = ""; // ì´ˆê¸°í™”

            const monthLabel = today.toLocaleString('en-US', { month: 'short' }).toUpperCase();
            const monthSpan = document.createElement('span');
            monthSpan.className = 'month-label';
            monthSpan.textContent = monthLabel;
            dateListEl.appendChild(monthSpan);

            const startDate = new Date(selectedStartDate); // ì„ íƒëœ ì‹œì‘ ë‚ ì§œ
            for (let i = -5; i <= 4; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i); // ì„ íƒí•œ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ 10ì¼ê°„ ë‚ ì§œ ê³„ì‚°
                const key = formatDate(currentDate);

                const btn = document.createElement('button');
                btn.textContent = currentDate.getDate();
                btn.className = 'date-button';
                btn.dataset.date = key;

                if (key === todayKey) {
                    btn.classList.add('today');
                }

                if (key === selectedDate) {
                    btn.classList.add('selected');
                }

                // ğŸ”¸ ìƒ‰ìƒ ê²°ì •
                getDoc(doc(db, "journals", key)).then(docSnap => {
                    if (docSnap.exists()) {
                        btn.style.backgroundColor = "#ffb6c1"; // í•‘í¬ (ìˆìŒ)
                    } else {
                        btn.style.backgroundColor = "lightgray"; // íšŒìƒ‰ (ì—†ìŒ)
                    }
                });

                // ğŸ”¸ í´ë¦­ ì´ë²¤íŠ¸
                btn.addEventListener("click", async () => {
                    selectedDate = key;
                    selectedStartDate = key; // ì„ íƒëœ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ 10ì¼ ê°±ì‹ 
                    renderDateButtons(); // ë‚ ì§œ ë²„íŠ¼ ê°±ì‹ 
                    await loadJournal(key);
                });

                dateListEl.appendChild(btn);
            }
        }

        // ğŸ”¹ ì›”ê°„ ë‹¬ë ¥ì—ì„œ ë‚ ì§œ í´ë¦­ ì‹œ 10ì¼ê°„ ë‹¬ë ¥ ê°±ì‹ 
        function renderCalendar() {
            const calendarEl = document.getElementById("calendar");
            calendarEl.innerHTML = ''; // ê¸°ì¡´ ë‹¬ë ¥ ë‚´ìš© ì´ˆê¸°í™”

            // í˜„ì¬ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•´ë‹¹ ì›”ì˜ ì²«ë‚ ê³¼ ë§ˆì§€ë§‰ ë‚ ì§œ êµ¬í•˜ê¸°
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            // ì²« ë²ˆì§¸ ìš”ì¼ì— ë§ì¶° ê³µë°± ì¶”ê°€
            const startDay = firstDayOfMonth.getDay();
            const totalDays = lastDayOfMonth.getDate();

            const calendarGrid = document.createElement("div");
            calendarGrid.className = "calendar";

            // ìš”ì¼ ì´ë¦„ ì¶”ê°€ (ì¼, ì›”, í™”, ìˆ˜, ëª©, ê¸ˆ, í† )
            const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            weekdays.forEach(day => {
                const dayLabel = document.createElement("div");
                dayLabel.textContent = day;
                calendarGrid.appendChild(dayLabel);
            });

            // ì²« ë²ˆì§¸ ë‚ ë¶€í„° ë¹ˆì¹¸ ì¶”ê°€
            for (let i = 0; i < startDay; i++) {
                const emptyCell = document.createElement("div");
                calendarGrid.appendChild(emptyCell);
            }

            // ë‚ ì§œ ì¶”ê°€
            for (let day = 1; day <= totalDays; day++) {
                const dayCell = document.createElement("div");
                dayCell.textContent = day;
                dayCell.className = "day";
                const dateKey = formatDate(new Date(today.getFullYear(), today.getMonth(), day));

                // ë‚ ì§œ í´ë¦­ ì‹œ í•´ë‹¹ ë‚ ì§œ ì €ë„ í‘œì‹œ
                dayCell.addEventListener("click", async () => {
                    selectedStartDate = dateKey; // ì›”ê°„ ë‹¬ë ¥ì—ì„œ í´ë¦­í•œ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ 10ì¼ ê°±ì‹ 
                    renderDateButtons(); // 10ì¼ ê°±ì‹ 
                    await loadJournal(dateKey); // í•´ë‹¹ ë‚ ì§œì˜ ì €ë„ ë¡œë“œ
                    selectedDate = dateKey; // ì„ íƒëœ ë‚ ì§œë¡œ ì„¤ì •
                });

                // í´ë¦­í•œ ë‚ ì§œê°€ ì˜¤ëŠ˜ ë‚ ì§œì¼ ê²½ìš° ê°•ì¡°
                if (dateKey === todayKey) {
                    dayCell.style.backgroundColor = "#ffb6c18e";
                }

                // í´ë¦­í•œ ë‚ ì§œê°€ ì„ íƒëœ ë‚ ì§œì¼ ê²½ìš° ê°•ì¡°
                if (dateKey === selectedDate) {
                    dayCell.style.backgroundColor = "#b6ffb6";
                }

                calendarGrid.appendChild(dayCell);
            }

            calendarEl.appendChild(calendarGrid);
        }

        // ğŸ”¹ ë‚ ì§œ ì €ë„ ë¡œë“œ í•¨ìˆ˜
        async function loadJournal(dateKey) {
            const docRef = doc(db, "journals", dateKey);
            const docSnap = await getDoc(docRef);
            const journalDisplay = document.getElementById("journal-display");

            if (docSnap.exists()) {
                journalDisplay.innerHTML = `<h2>Journal for ${dateKey}</h2><p>${docSnap.data().text}</p>`;
            } else {
                journalDisplay.innerHTML = `<h2>No journal for ${dateKey}</h2><p>You haven't written a journal entry for this date.</p>`;
            }
        }

        // ğŸ”¹ í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë‹¬ë ¥ê³¼ ë‚ ì§œ ë²„íŠ¼ ë Œë”ë§
        window.onload = () => {
            renderDateButtons(); // 10ì¼ ë‹¬ë ¥ ë Œë”ë§
            renderCalendar(); // ì›”ê°„ ë‹¬ë ¥ ë Œë”ë§
        };
    </script>
</body>

</html>